---
phase: 02-authentication-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/src/contexts/AuthContext.tsx
  - frontend/src/main.tsx
autonomous: true

must_haves:
  truths:
    - "AuthContext exists and provides session state"
    - "useAuth hook returns session, user, isLoading, signOut"
    - "React Router v6 is installed and configured"
  artifacts:
    - path: "frontend/src/contexts/AuthContext.tsx"
      provides: "Auth state management with Supabase"
      exports: ["AuthProvider", "useAuth"]
    - path: "frontend/package.json"
      provides: "React Router dependency"
      contains: "react-router-dom"
  key_links:
    - from: "frontend/src/contexts/AuthContext.tsx"
      to: "frontend/src/lib/supabase.ts"
      via: "import supabase client"
      pattern: "import.*supabase"
    - from: "frontend/src/contexts/AuthContext.tsx"
      to: "supabase.auth.onAuthStateChange"
      via: "auth state listener"
      pattern: "onAuthStateChange"
---

<objective>
Set up the authentication foundation: AuthContext with session management and React Router v6.

Purpose: Create the core infrastructure that all auth features will build upon. AuthContext manages Supabase session state and provides it to the entire app via React Context. React Router enables protected routes and navigation.

Output: Working AuthContext with useAuth hook, React Router installed, foundation ready for auth UI components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-system/02-RESEARCH.md
@frontend/src/lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install React Router v6</name>
  <files>
    frontend/package.json
  </files>
  <action>
Install React Router v6 in the frontend:

```bash
cd /Users/seijimatsuda/session_planner_1-22-26/frontend
npm install react-router-dom
```

React Router v6 is required for:
- Protected route pattern using `<Outlet />`
- `useNavigate` for programmatic navigation after login/logout
- `useLocation` for preserving intended destination on redirect
  </action>
  <verify>
```bash
cd /Users/seijimatsuda/session_planner_1-22-26/frontend
grep -q "react-router-dom" package.json && echo "React Router installed"
```
  </verify>
  <done>react-router-dom installed in frontend package.json</done>
</task>

<task type="auto">
  <name>Task 2: Create AuthContext with session management</name>
  <files>
    frontend/src/contexts/AuthContext.tsx
  </files>
  <action>
Create the AuthContext that manages Supabase session state.

Create directory and file:
```bash
mkdir -p /Users/seijimatsuda/session_planner_1-22-26/frontend/src/contexts
```

Create `frontend/src/contexts/AuthContext.tsx`:

```tsx
import { createContext, useContext, useEffect, useState } from 'react'
import { Session, User } from '@supabase/supabase-js'
import { supabase } from '../lib/supabase'

interface AuthContextType {
  session: Session | null
  user: User | null
  isLoading: boolean
  signOut: () => Promise<void>
}

const AuthContext = createContext<AuthContextType | undefined>(undefined)

export const useAuth = () => {
  const context = useContext(AuthContext)
  if (!context) {
    throw new Error('useAuth must be used within AuthProvider')
  }
  return context
}

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [session, setSession] = useState<Session | null>(null)
  const [isLoading, setIsLoading] = useState(true)

  useEffect(() => {
    // Get initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session)
      setIsLoading(false)
    })

    // Listen for auth state changes
    // CRITICAL: Do NOT use async callback or call other Supabase methods here
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      (_event, session) => {
        setSession(session)
      }
    )

    // Cleanup subscription on unmount
    return () => subscription.unsubscribe()
  }, [])

  const signOut = async () => {
    await supabase.auth.signOut()
  }

  const value = {
    session,
    user: session?.user ?? null,
    isLoading,
    signOut,
  }

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>
}
```

Key implementation details:
- `isLoading` starts as `true` to prevent flash of unauthenticated content
- `onAuthStateChange` callback is synchronous (no async) to avoid deadlocks
- `subscription.unsubscribe()` in cleanup to prevent memory leaks
- `user` derived from `session?.user` for convenience
  </action>
  <verify>
```bash
cd /Users/seijimatsuda/session_planner_1-22-26/frontend
ls src/contexts/AuthContext.tsx && echo "AuthContext file created"
grep -q "onAuthStateChange" src/contexts/AuthContext.tsx && echo "Auth listener implemented"
grep -q "export function AuthProvider" src/contexts/AuthContext.tsx && echo "AuthProvider exported"
grep -q "export const useAuth" src/contexts/AuthContext.tsx && echo "useAuth exported"
npx tsc --noEmit && echo "TypeScript compiles"
```
  </verify>
  <done>
- AuthContext.tsx created with session state management
- useAuth hook exported for consuming components
- AuthProvider exported for wrapping app
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Wrap app with AuthProvider</name>
  <files>
    frontend/src/main.tsx
  </files>
  <action>
Update `frontend/src/main.tsx` to wrap the app with AuthProvider:

```tsx
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import { AuthProvider } from './contexts/AuthContext'
import './index.css'
import App from './App.tsx'

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <AuthProvider>
      <App />
    </AuthProvider>
  </StrictMode>,
)
```

AuthProvider must wrap the entire app so all components have access to auth state via useAuth hook.
  </action>
  <verify>
```bash
cd /Users/seijimatsuda/session_planner_1-22-26/frontend
grep -q "AuthProvider" src/main.tsx && echo "AuthProvider wrapping app"
grep -q "import { AuthProvider }" src/main.tsx && echo "AuthProvider imported"
npx tsc --noEmit && echo "TypeScript compiles"
```
  </verify>
  <done>
- main.tsx wraps App with AuthProvider
- Auth state available throughout app
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. React Router installed:
```bash
cd /Users/seijimatsuda/session_planner_1-22-26/frontend
npm list react-router-dom
```

2. AuthContext structure:
```bash
ls -la /Users/seijimatsuda/session_planner_1-22-26/frontend/src/contexts/
cat /Users/seijimatsuda/session_planner_1-22-26/frontend/src/contexts/AuthContext.tsx | head -20
```

3. TypeScript compiles:
```bash
cd /Users/seijimatsuda/session_planner_1-22-26/frontend
npx tsc --noEmit
```

4. Dev server starts (basic smoke test):
```bash
cd /Users/seijimatsuda/session_planner_1-22-26/frontend
npm run dev &
sleep 5
curl -s http://localhost:5173 | grep -q "Soccer" && echo "Frontend running"
kill %1 2>/dev/null
```
</verification>

<success_criteria>
- [ ] `react-router-dom` appears in frontend/package.json dependencies
- [ ] `frontend/src/contexts/AuthContext.tsx` exports AuthProvider and useAuth
- [ ] `frontend/src/main.tsx` wraps App with AuthProvider
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] Dev server starts without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-system/02-01-SUMMARY.md`
</output>
