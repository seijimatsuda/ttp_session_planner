---
phase: 15-performance-optimization
plan: 03
type: execute
wave: 2
depends_on: ["15-01", "15-02"]
files_modified:
  - frontend/src/components/drills/VirtualDrillGrid.tsx
  - frontend/src/pages/DrillLibraryPage.tsx
  - frontend/package.json
autonomous: false

must_haves:
  truths:
    - "Drill library renders 100+ drills without visible lag"
    - "Only visible drill cards are rendered in DOM"
    - "Scrolling through large drill lists is smooth"
  artifacts:
    - path: "frontend/src/components/drills/VirtualDrillGrid.tsx"
      provides: "Virtualized drill grid using TanStack Virtual"
      contains: "useVirtualizer"
    - path: "frontend/src/pages/DrillLibraryPage.tsx"
      provides: "DrillLibraryPage using VirtualDrillGrid"
      contains: "VirtualDrillGrid"
  key_links:
    - from: "VirtualDrillGrid.tsx"
      to: "@tanstack/react-virtual"
      via: "useVirtualizer hook"
      pattern: "useVirtualizer\\("
    - from: "DrillLibraryPage.tsx"
      to: "VirtualDrillGrid"
      via: "component import"
      pattern: "import.*VirtualDrillGrid"
---

<objective>
Implement list virtualization for the drill library to handle 100+ drills smoothly

Purpose: Ensure drill library remains performant as users build large drill collections by rendering only visible items
Output: VirtualDrillGrid component using TanStack Virtual, DrillLibraryPage using virtualized grid
</objective>

<execution_context>
@/Users/seijimatsuda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seijimatsuda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-performance-optimization/15-RESEARCH.md

@frontend/src/components/drills/DrillGrid.tsx
@frontend/src/components/drills/DrillCard.tsx
@frontend/src/pages/DrillLibraryPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install TanStack Virtual and create VirtualDrillGrid</name>
  <files>frontend/package.json, frontend/src/components/drills/VirtualDrillGrid.tsx, frontend/src/components/drills/index.ts</files>
  <action>
1. Install @tanstack/react-virtual:
   `cd frontend && npm install @tanstack/react-virtual`

2. Create VirtualDrillGrid.tsx in components/drills/:

```typescript
/**
 * VirtualDrillGrid - virtualized grid for 100+ drills
 *
 * Uses TanStack Virtual for performance with large drill collections.
 * Renders only visible rows, dramatically reducing DOM nodes.
 */

import { useRef, useMemo } from 'react'
import { useVirtualizer } from '@tanstack/react-virtual'
import type { Drill } from '@/lib/database.types'
import { DrillCard } from './DrillCard'
import { DrillEmptyState } from './DrillEmptyState'
import { Skeleton } from '@/components/ui/Skeleton'

interface VirtualDrillGridProps {
  drills: Drill[]
  isLoading: boolean
  hasActiveFilters: boolean
}

// Number of columns based on breakpoints (mirrors DrillGrid)
// We'll use a fixed 4 columns for virtualization simplicity
// Responsive behavior handled via CSS on parent container
const COLUMNS = 4
const ROW_HEIGHT = 280  // Approximate height of DrillCard + gap
const OVERSCAN = 2      // Render 2 extra rows above/below viewport

function DrillCardSkeleton() {
  return (
    <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
      <Skeleton className="aspect-video" />
      <div className="p-4">
        <Skeleton width="60%" height={20} className="mb-2" />
        <Skeleton width={80} height={24} />
      </div>
    </div>
  )
}

export function VirtualDrillGrid({
  drills,
  isLoading,
  hasActiveFilters,
}: VirtualDrillGridProps) {
  const parentRef = useRef<HTMLDivElement>(null)

  // Group drills into rows for grid virtualization
  const rows = useMemo(() => {
    const result: Drill[][] = []
    for (let i = 0; i < drills.length; i += COLUMNS) {
      result.push(drills.slice(i, i + COLUMNS))
    }
    return result
  }, [drills])

  const virtualizer = useVirtualizer({
    count: rows.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => ROW_HEIGHT,
    overscan: OVERSCAN,
  })

  // Loading state
  if (isLoading) {
    return (
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        {Array.from({ length: 8 }).map((_, index) => (
          <DrillCardSkeleton key={index} />
        ))}
      </div>
    )
  }

  // Empty state
  if (drills.length === 0) {
    return <DrillEmptyState hasFilters={hasActiveFilters} />
  }

  // For small lists (< 50), use regular grid (virtualization overhead not worth it)
  if (drills.length < 50) {
    return (
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        {drills.map((drill) => (
          <DrillCard key={drill.id} drill={drill} />
        ))}
      </div>
    )
  }

  // Virtualized grid for large lists
  return (
    <div
      ref={parentRef}
      className="h-[calc(100vh-300px)] overflow-auto"
      style={{ contain: 'strict' }}
    >
      <div
        style={{
          height: `${virtualizer.getTotalSize()}px`,
          width: '100%',
          position: 'relative',
        }}
      >
        {virtualizer.getVirtualItems().map((virtualRow) => (
          <div
            key={virtualRow.key}
            style={{
              position: 'absolute',
              top: 0,
              left: 0,
              width: '100%',
              transform: `translateY(${virtualRow.start}px)`,
            }}
          >
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-4">
              {rows[virtualRow.index].map((drill) => (
                <DrillCard key={drill.id} drill={drill} />
              ))}
            </div>
          </div>
        ))}
      </div>
    </div>
  )
}
```

3. Export VirtualDrillGrid from components/drills/index.ts:
   Add: `export { VirtualDrillGrid } from './VirtualDrillGrid'`
  </action>
  <verify>
`cd frontend && npm run build` - compiles without TypeScript errors
  </verify>
  <done>
TanStack Virtual installed, VirtualDrillGrid component created with row-based virtualization
  </done>
</task>

<task type="auto">
  <name>Task 2: Update DrillLibraryPage to use VirtualDrillGrid</name>
  <files>frontend/src/pages/DrillLibraryPage.tsx</files>
  <action>
Update DrillLibraryPage.tsx to use VirtualDrillGrid:

1. Update import to include VirtualDrillGrid:
   `import { DrillFilters, VirtualDrillGrid } from '@/components/drills'`

2. Replace DrillGrid with VirtualDrillGrid in the render:
   Change:
   ```tsx
   <DrillGrid
     drills={filteredDrills}
     isLoading={isLoading}
     hasActiveFilters={hasActiveFilters}
   />
   ```
   To:
   ```tsx
   <VirtualDrillGrid
     drills={filteredDrills}
     isLoading={isLoading}
     hasActiveFilters={hasActiveFilters}
   />
   ```

Keep all other code (filters, state management, useMemo) unchanged.
The VirtualDrillGrid handles the <50 drills case internally by falling back to regular rendering.
  </action>
  <verify>
1. Run `cd frontend && npm run dev`
2. Navigate to /drills
3. Verify page renders correctly with existing drills
4. Scroll through the list - verify smooth scrolling
  </verify>
  <done>
DrillLibraryPage uses VirtualDrillGrid, renders correctly with existing drills
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify performance with simulated large dataset</name>
  <what-built>
- Route-based code splitting (Plan 15-01)
- Image lazy loading with native loading="lazy" (Plan 15-02)
- React Query cache optimization (Plan 15-02)
- List virtualization for drill library (this plan)
  </what-built>
  <how-to-verify>
1. **Run Lighthouse Audit:**
   - Open the app at https://localhost:5173/drills (or production URL)
   - Open Chrome DevTools > Lighthouse tab
   - Run "Performance" audit for mobile
   - Target: LCP < 2.5s, FCP < 1.8s

2. **Verify Code Splitting:**
   - Open DevTools Network tab
   - Navigate from login to dashboard to /drills
   - Confirm separate JS chunks load for each route

3. **Verify Image Lazy Loading:**
   - On /drills page, open Network tab filtered to "Img"
   - Scroll down slowly
   - Confirm images load as they enter viewport

4. **Verify Query Caching:**
   - Navigate away from /drills to dashboard
   - Navigate back to /drills
   - Confirm no new network request for drills (cached)

5. **Test Large List (if possible):**
   - Create 10-20 test drills if you don't have many
   - Scroll through the list
   - Confirm smooth scrolling without jank
   - Check DevTools Elements panel: only a few DrillCard elements in DOM (not all)

Note: Full 100+ drill testing may require adding test data. The virtualization threshold is set at 50+ drills.
  </how-to-verify>
  <resume-signal>Type "verified" to confirm all performance optimizations work, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TanStack Virtual installed in package.json
2. VirtualDrillGrid component exists and exports correctly
3. DrillLibraryPage uses VirtualDrillGrid
4. Page loads and renders correctly
5. Virtualization activates for 50+ drills
6. Scrolling is smooth without lag
</verification>

<success_criteria>
- TanStack Virtual installed and configured
- VirtualDrillGrid renders only visible rows
- Drill library handles 100+ drills without performance degradation
- Small lists (<50) render without virtualization (simpler)
- Human verified: Lighthouse scores acceptable, code splitting working, caching effective
</success_criteria>

<output>
After completion, create `.planning/phases/15-performance-optimization/15-03-SUMMARY.md`
</output>
