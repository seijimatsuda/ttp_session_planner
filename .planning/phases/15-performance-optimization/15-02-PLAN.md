---
phase: 15-performance-optimization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/drills/DrillCard.tsx
  - frontend/src/hooks/useDrills.ts
  - frontend/src/hooks/useSessions.ts
autonomous: true

must_haves:
  truths:
    - "Drill thumbnails lazy load when scrolled into view"
    - "React Query caches drills for 5 minutes before refetching"
    - "React Query caches sessions for 2 minutes before refetching"
  artifacts:
    - path: "frontend/src/components/drills/DrillCard.tsx"
      provides: "Image with native lazy loading"
      contains: "loading=\"lazy\""
    - path: "frontend/src/hooks/useDrills.ts"
      provides: "Drill queries with optimized staleTime"
      contains: "staleTime"
    - path: "frontend/src/hooks/useSessions.ts"
      provides: "Session queries with optimized staleTime"
      contains: "staleTime"
  key_links:
    - from: "DrillCard.tsx"
      to: "img element"
      via: "loading attribute"
      pattern: "loading=[\"']lazy[\"']"
---

<objective>
Add native image lazy loading and tune React Query cache settings

Purpose: Reduce initial bandwidth by lazy loading below-fold images and minimize API calls through optimized caching
Output: DrillCard with lazy loading, useDrills/useSessions hooks with tuned staleTime and gcTime
</objective>

<execution_context>
@/Users/seijimatsuda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seijimatsuda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-performance-optimization/15-RESEARCH.md

@frontend/src/components/drills/DrillCard.tsx
@frontend/src/hooks/useDrills.ts
@frontend/src/hooks/useSessions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add native lazy loading to DrillCard images</name>
  <files>frontend/src/components/drills/DrillCard.tsx</files>
  <action>
Update the img element in DrillCard.tsx:

1. Add loading="lazy" attribute to the img element
2. Add explicit width and height attributes to prevent layout shift:
   - width="320" height="180" (matches aspect-video ratio 16:9)
3. Keep existing className "w-full h-full object-cover"

The img tag should look like:
```tsx
<img
  src={getProxyMediaUrl('drills', drill.video_file_path)}
  alt=""
  loading="lazy"
  width="320"
  height="180"
  className="w-full h-full object-cover"
/>
```

Note: Only images below the fold benefit from lazy loading. The grid typically shows
4-8 cards initially, so most drill thumbnails will lazy load when scrolling.
  </action>
  <verify>
1. Run `cd frontend && npm run dev`
2. Open DevTools Network tab, filter by "Img"
3. Navigate to /drills page
4. Scroll down - verify images load as they scroll into view (not all at once)
  </verify>
  <done>
DrillCard images have loading="lazy" and explicit dimensions, images load progressively on scroll
  </done>
</task>

<task type="auto">
  <name>Task 2: Tune React Query cache settings for drills</name>
  <files>frontend/src/hooks/useDrills.ts</files>
  <action>
Update useDrills hook to add optimized cache settings:

1. Add staleTime: 5 * 60 * 1000 (5 minutes) - drills change infrequently
2. Add gcTime: 10 * 60 * 1000 (10 minutes) - keep in cache longer for quick returns

For useDrill (single drill detail):
- staleTime: 5 * 60 * 1000 (5 minutes)
- gcTime: 10 * 60 * 1000 (10 minutes)

Both queries should now include these options in their useQuery calls.
Keep existing queryKey structure and queryFn unchanged.
Keep existing `enabled` conditions unchanged.

Example update:
```typescript
return useQuery({
  queryKey: drillKeys.list(userId),
  queryFn: () => getDrills(supabase, userId!),
  enabled: !!userId,
  staleTime: 5 * 60 * 1000,  // 5 minutes
  gcTime: 10 * 60 * 1000,    // 10 minutes
})
```
  </action>
  <verify>
1. Run `cd frontend && npm run dev`
2. Navigate to /drills, let drills load
3. Navigate away to dashboard, then back to /drills
4. Verify in Network tab: No new API request made (cached data used)
5. Wait 5+ minutes, refresh page - verify data refetches
  </verify>
  <done>
useDrills and useDrill configured with 5-minute staleTime and 10-minute gcTime
  </done>
</task>

<task type="auto">
  <name>Task 3: Tune React Query cache settings for sessions</name>
  <files>frontend/src/hooks/useSessions.ts</files>
  <action>
Update useSessions hooks with optimized cache settings:

For useSessions (list):
- staleTime: 2 * 60 * 1000 (2 minutes) - sessions change more frequently than drills
- gcTime: 5 * 60 * 1000 (5 minutes)

For useSession (single session detail):
- staleTime: 1 * 60 * 1000 (1 minute) - single session may change during editing
- gcTime: 5 * 60 * 1000 (5 minutes)

Keep existing queryKey structure, queryFn, and enabled conditions unchanged.

Sessions need shorter staleTime than drills because:
- Users actively edit sessions during planning
- Multiple sessions might be worked on in quick succession
- Grid_data changes frequently during session building
  </action>
  <verify>
1. Run `cd frontend && npm run dev`
2. Navigate to /sessions, let sessions load
3. Navigate to dashboard, then back to /sessions
4. Verify in Network tab: No new API request made within 2 minutes
  </verify>
  <done>
useSessions configured with 2-minute staleTime, useSession with 1-minute staleTime
  </done>
</task>

</tasks>

<verification>
1. DrillCard images have loading="lazy" and dimensions
2. Images lazy load when scrolling (visible in Network tab)
3. Drill queries use 5-minute staleTime
4. Session queries use appropriate staleTime (2min list, 1min detail)
5. Navigation between pages doesn't trigger unnecessary refetches
</verification>

<success_criteria>
- Drill thumbnails lazy load on scroll
- No layout shift when images load (explicit dimensions)
- React Query caches drills for 5 minutes
- React Query caches sessions for 2 minutes (list) / 1 minute (detail)
- Navigating between pages reuses cached data
</success_criteria>

<output>
After completion, create `.planning/phases/15-performance-optimization/15-02-SUMMARY.md`
</output>
