---
phase: 01-project-setup-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/tsconfig.json
  - backend/src/app.ts
  - backend/src/server.ts
autonomous: true

must_haves:
  truths:
    - "Developer can run npm run dev and see Express server at localhost:3000"
    - "TypeScript compilation succeeds with strict mode"
    - "Health endpoint returns JSON response"
  artifacts:
    - path: "backend/package.json"
      provides: "Project configuration with Express 5 and TypeScript"
      contains: "express"
    - path: "backend/tsconfig.json"
      provides: "TypeScript configuration with strict mode"
      contains: "strict"
    - path: "backend/src/app.ts"
      provides: "Express application setup"
      exports: ["default"]
    - path: "backend/src/server.ts"
      provides: "HTTP server startup"
      contains: "listen"
  key_links:
    - from: "backend/src/server.ts"
      to: "backend/src/app.ts"
      via: "import"
      pattern: "import app"
    - from: "backend/src/app.ts"
      to: "express"
      via: "import"
      pattern: "import express"
---

<objective>
Scaffold the backend Express.js server with TypeScript strict mode and ES modules.

Purpose: Establish the backend foundation that will handle API routes, the iOS video proxy, and server-side Supabase operations. This runs in parallel with frontend setup.

Output: A working backend/ directory with Express.js 5, TypeScript strict mode, running locally at localhost:3000 with a health check endpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-project-setup-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize backend project with Express 5 and TypeScript</name>
  <files>
    backend/package.json
    backend/tsconfig.json
  </files>
  <action>
Create the backend directory and initialize npm:

```bash
cd /Users/seijimatsuda/session_planner_1-22-26
mkdir -p backend
cd backend
npm init -y
```

Install Express 5 and TypeScript dependencies:

```bash
npm install express@5
npm install -D typescript @types/node @types/express tsx
npm install cors dotenv
npm install -D @types/cors
```

Create tsconfig.json with strict mode and ES modules:

```json
{
  "compilerOptions": {
    "target": "ES2023",
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "declarationMap": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

Update package.json to use ES modules and add scripts:

```json
{
  "type": "module",
  "main": "dist/server.js",
  "scripts": {
    "dev": "tsx watch src/server.ts",
    "build": "tsc",
    "start": "node dist/server.js"
  }
}
```

IMPORTANT:
- "type": "module" enables ES modules (import/export)
- tsx is used for development (fast TS execution without build)
- tsc builds for production
  </action>
  <verify>
```bash
cd /Users/seijimatsuda/session_planner_1-22-26/backend
cat package.json | grep -q '"type": "module"' && echo "ES modules enabled"
cat tsconfig.json | grep -q '"strict": true' && echo "Strict mode enabled"
ls node_modules/express && echo "Express installed"
```
  </verify>
  <done>backend/ initialized with Express 5, TypeScript strict mode, and ES modules</done>
</task>

<task type="auto">
  <name>Task 2: Create Express app with CORS and health endpoint</name>
  <files>
    backend/src/app.ts
    backend/src/server.ts
  </files>
  <action>
Create src directory:

```bash
mkdir -p /Users/seijimatsuda/session_planner_1-22-26/backend/src
```

Create src/app.ts with Express configuration:

```typescript
import express, { Request, Response, NextFunction } from 'express'
import cors from 'cors'

const app = express()

// CORS configuration - will be updated with actual frontend URL in production
app.use(cors({
  origin: process.env.FRONTEND_URL || 'http://localhost:5173',
  credentials: true
}))

app.use(express.json())
app.use(express.urlencoded({ extended: true }))

// Health check endpoint
app.get('/health', (req: Request, res: Response) => {
  res.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    service: 'soccer-session-planner-api'
  })
})

// Root endpoint
app.get('/', (req: Request, res: Response) => {
  res.json({
    message: 'Soccer Session Planner API',
    version: '1.0.0',
    endpoints: {
      health: '/health'
    }
  })
})

// Error handling middleware - Express 5 supports async errors natively
app.use((err: Error, req: Request, res: Response, next: NextFunction) => {
  console.error(err.stack)
  res.status(500).json({ error: 'Something went wrong!' })
})

export default app
```

Create src/server.ts to start the HTTP server:

```typescript
import app from './app.js'

const PORT = process.env.PORT || 3000

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`)
  console.log(`Health check: http://localhost:${PORT}/health`)
})
```

IMPORTANT:
- Import uses './app.js' extension (required for ES modules in Node.js)
- CORS is pre-configured for local frontend (port 5173)
- Health endpoint is essential for Render deployment health checks
  </action>
  <verify>
```bash
cd /Users/seijimatsuda/session_planner_1-22-26/backend
ls src/app.ts src/server.ts && echo "Source files created"
grep -q "cors" src/app.ts && echo "CORS configured"
grep -q "/health" src/app.ts && echo "Health endpoint exists"
```
  </verify>
  <done>Express app created with CORS, health endpoint, and error handling</done>
</task>

<task type="auto">
  <name>Task 3: Verify dev server runs and TypeScript compiles</name>
  <files>
    backend/dist/
  </files>
  <action>
Verify TypeScript compilation works:

```bash
cd /Users/seijimatsuda/session_planner_1-22-26/backend
npm run build
```

This should create dist/ with compiled JavaScript.

Start the dev server and test endpoints:

```bash
cd /Users/seijimatsuda/session_planner_1-22-26/backend
npm run dev &
sleep 3

# Test health endpoint
curl http://localhost:3000/health

# Test root endpoint
curl http://localhost:3000/

# Stop server
kill %1
```

Both endpoints should return JSON responses.

Add .gitignore for backend:

```
node_modules/
dist/
.env
```
  </action>
  <verify>
```bash
cd /Users/seijimatsuda/session_planner_1-22-26/backend
npm run build && echo "TypeScript builds successfully"
ls dist/server.js dist/app.js && echo "Compiled files exist"

# Test server
npm run dev &
sleep 3
curl -s http://localhost:3000/health | grep -q "ok" && echo "Health endpoint works"
kill %1 2>/dev/null
```
  </verify>
  <done>
- TypeScript compiles without errors
- Dev server runs at localhost:3000
- Health endpoint returns JSON with status: ok
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Backend directory structure:
```bash
ls -la backend/
ls -la backend/src/
```

2. TypeScript compiles:
```bash
cd backend && npm run build
ls -la dist/
```

3. Dev server runs:
```bash
cd backend && npm run dev &
sleep 3
curl http://localhost:3000/health
curl http://localhost:3000/
kill %1
```
</verification>

<success_criteria>
- [ ] `npm run dev` starts Express server on port 3000
- [ ] `npm run build` compiles TypeScript to dist/
- [ ] `curl http://localhost:3000/health` returns `{"status":"ok",...}`
- [ ] `curl http://localhost:3000/` returns API info JSON
- [ ] TypeScript strict mode enabled (no `any` types without explicit annotation)
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup-infrastructure/01-02-SUMMARY.md`
</output>
