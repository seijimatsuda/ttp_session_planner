---
phase: 01-project-setup-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - frontend/src/lib/supabase.ts
  - frontend/.env.local
  - frontend/src/App.tsx
  - backend/src/config/supabase.ts
  - backend/.env
  - backend/src/app.ts
autonomous: false

user_setup:
  - service: supabase
    why: "Database, auth, and storage for the application"
    env_vars:
      - name: VITE_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: VITE_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon/public key"
      - name: SUPABASE_URL
        source: "Same as VITE_SUPABASE_URL"
      - name: SUPABASE_ANON_KEY
        source: "Same as VITE_SUPABASE_ANON_KEY"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> service_role key (secret)"
    dashboard_config:
      - task: "Create new Supabase project"
        location: "https://supabase.com/dashboard -> New Project"
      - task: "Copy API credentials"
        location: "Project Settings -> API"

must_haves:
  truths:
    - "Frontend can connect to Supabase and verify connection"
    - "Backend can connect to Supabase and verify connection"
    - "Environment variables are properly configured for local development"
  artifacts:
    - path: "frontend/src/lib/supabase.ts"
      provides: "Browser Supabase client"
      contains: "createClient"
    - path: "frontend/.env.local"
      provides: "Frontend environment variables"
      contains: "VITE_SUPABASE"
    - path: "backend/src/config/supabase.ts"
      provides: "Server Supabase client"
      contains: "createClient"
    - path: "backend/.env"
      provides: "Backend environment variables"
      contains: "SUPABASE"
  key_links:
    - from: "frontend/src/lib/supabase.ts"
      to: "supabase"
      via: "createClient"
      pattern: "createClient\\(.*supabaseUrl"
    - from: "backend/src/config/supabase.ts"
      to: "supabase"
      via: "createClient"
      pattern: "createClient\\(.*SUPABASE_URL"
---

<objective>
Configure Supabase clients for both frontend and backend with proper environment variable setup.

Purpose: Enable database, auth, and storage capabilities across the entire application. Supabase is the backbone for all data operations.

Output: Working Supabase connections in both frontend and backend, verified locally.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-project-setup-infrastructure/01-RESEARCH.md
@.planning/phases/01-project-setup-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-project-setup-infrastructure/01-02-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Create Supabase project and get credentials</name>
  <action>
User must create a Supabase project and provide credentials. This cannot be automated.
  </action>
  <instructions>
1. Go to https://supabase.com/dashboard
2. Click "New Project" (or use existing project)
3. Choose organization, enter project name: "soccer-session-planner"
4. Generate a strong database password (save it securely)
5. Select region closest to your users
6. Wait for project to be created (~2 minutes)
7. Go to Project Settings -> API
8. Copy these values:
   - **Project URL** (looks like: https://xxxxx.supabase.co)
   - **anon public** key (starts with: eyJhbGc...)
   - **service_role** key (starts with: eyJhbGc... - keep this SECRET)
  </instructions>
  <resume-signal>
Provide the three values:
- SUPABASE_URL: [paste Project URL]
- SUPABASE_ANON_KEY: [paste anon public key]
- SUPABASE_SERVICE_ROLE_KEY: [paste service_role key]

Or type "done" if you've added them to the .env files manually.
  </resume-signal>
</task>

<task type="auto">
  <name>Task 2: Configure frontend Supabase client</name>
  <files>
    frontend/src/lib/supabase.ts
    frontend/.env.local
  </files>
  <action>
Install Supabase client in frontend:

```bash
cd /Users/seijimatsuda/session_planner_1-22-26/frontend
npm install @supabase/supabase-js @supabase/ssr
```

Create frontend/.env.local with Supabase credentials (use values from Task 1):

```env
VITE_SUPABASE_URL=https://xxxxx.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGc...
VITE_API_URL=http://localhost:3000
```

Create src/lib/supabase.ts for browser client:

```typescript
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Missing Supabase environment variables. Check .env.local')
}

export const supabase = createClient(supabaseUrl, supabaseAnonKey)
```

IMPORTANT:
- VITE_ prefix is required for Vite to expose variables to browser
- anon key is safe for browser (RLS protects data)
- Never expose service_role key in frontend
  </action>
  <verify>
```bash
cd /Users/seijimatsuda/session_planner_1-22-26/frontend
ls src/lib/supabase.ts && echo "Supabase client created"
grep -q "VITE_SUPABASE_URL" .env.local && echo "Env vars configured"
grep -q "@supabase/supabase-js" package.json && echo "Supabase installed"
```
  </verify>
  <done>Frontend Supabase client configured with environment variables</done>
</task>

<task type="auto">
  <name>Task 3: Configure backend Supabase client and verify connections</name>
  <files>
    backend/src/config/supabase.ts
    backend/.env
    backend/src/app.ts
    frontend/src/App.tsx
  </files>
  <action>
Install Supabase client in backend:

```bash
cd /Users/seijimatsuda/session_planner_1-22-26/backend
npm install @supabase/supabase-js @supabase/ssr
```

Create backend/.env with Supabase credentials (use values from Task 1):

```env
PORT=3000
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_ANON_KEY=eyJhbGc...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc...
FRONTEND_URL=http://localhost:5173
NODE_ENV=development
```

Create src/config/supabase.ts for server client:

```typescript
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = process.env.SUPABASE_URL
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY
const supabaseAnonKey = process.env.SUPABASE_ANON_KEY

if (!supabaseUrl || !supabaseServiceKey || !supabaseAnonKey) {
  throw new Error('Missing Supabase environment variables. Check .env')
}

// Admin client - bypasses RLS, use only for admin operations
export const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
})

// Client factory for user-specific operations (respects RLS)
export const createSupabaseClient = (accessToken?: string) => {
  const options = accessToken
    ? {
        global: {
          headers: {
            Authorization: `Bearer ${accessToken}`
          }
        }
      }
    : {}
  return createClient(supabaseUrl, supabaseAnonKey, options)
}
```

Add dotenv import at the top of backend/src/server.ts:

```typescript
import 'dotenv/config'
import app from './app.js'

const PORT = process.env.PORT || 3000
// ... rest of file
```

Add a test endpoint to backend/src/app.ts to verify Supabase connection:

```typescript
// Add import at top
import { supabaseAdmin } from './config/supabase.js'

// Add test endpoint after health endpoint
app.get('/api/test-db', async (req: Request, res: Response) => {
  try {
    // This will fail until we create tables, but confirms connection
    const { error } = await supabaseAdmin.from('_test').select('*').limit(1)

    // 42P01 means table doesn't exist - that's expected and proves connection works
    if (error && error.code !== '42P01') {
      throw error
    }

    res.json({
      status: 'connected',
      message: 'Supabase connection successful'
    })
  } catch (err) {
    res.status(500).json({
      status: 'error',
      message: err instanceof Error ? err.message : 'Unknown error'
    })
  }
})
```

Update frontend/src/App.tsx to verify Supabase connection:

```tsx
import { useEffect, useState } from 'react'
import { supabase } from './lib/supabase'

function App() {
  const [connectionStatus, setConnectionStatus] = useState<'checking' | 'connected' | 'error'>('checking')

  useEffect(() => {
    const checkConnection = async () => {
      try {
        // Try to fetch from auth - this always works even with no tables
        const { error } = await supabase.auth.getSession()
        if (error) throw error
        setConnectionStatus('connected')
      } catch (err) {
        console.error('Supabase connection error:', err)
        setConnectionStatus('error')
      }
    }
    checkConnection()
  }, [])

  return (
    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
      <div className="bg-white p-8 rounded-lg shadow-md">
        <h1 className="text-3xl font-bold text-gray-900 mb-4">
          Soccer Session Planner
        </h1>
        <p className="text-gray-600 mb-4">
          Frontend setup complete. Ready for development.
        </p>
        <div className="flex items-center gap-2">
          <span className="text-sm text-gray-500">Supabase:</span>
          {connectionStatus === 'checking' && (
            <span className="text-yellow-600">Checking...</span>
          )}
          {connectionStatus === 'connected' && (
            <span className="text-green-600 font-medium">Connected</span>
          )}
          {connectionStatus === 'error' && (
            <span className="text-red-600 font-medium">Error</span>
          )}
        </div>
      </div>
    </div>
  )
}

export default App
```
  </action>
  <verify>
```bash
# Backend Supabase test
cd /Users/seijimatsuda/session_planner_1-22-26/backend
npm run dev &
sleep 3
curl -s http://localhost:3000/api/test-db | grep -q "connected" && echo "Backend Supabase: Connected"
kill %1 2>/dev/null

# Frontend check (TypeScript)
cd /Users/seijimatsuda/session_planner_1-22-26/frontend
npx tsc --noEmit && echo "Frontend TypeScript: OK"
```
  </verify>
  <done>
- Backend Supabase client configured with admin and user clients
- Frontend shows Supabase connection status
- Both compile without TypeScript errors
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Backend connects to Supabase:
```bash
cd backend && npm run dev &
sleep 3
curl http://localhost:3000/api/test-db
kill %1
```

2. Frontend shows connection status:
```bash
cd frontend && npm run dev &
sleep 3
curl http://localhost:5173
# Should show "Connected" for Supabase status when viewed in browser
kill %1
```

3. Environment files exist and are gitignored:
```bash
cat frontend/.env.local
cat backend/.env
git check-ignore frontend/.env.local backend/.env
```
</verification>

<success_criteria>
- [ ] Backend `/api/test-db` returns `{"status":"connected",...}`
- [ ] Frontend displays "Supabase: Connected" when opened in browser
- [ ] `.env.local` and `.env` files exist with Supabase credentials
- [ ] Both projects compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup-infrastructure/01-03-SUMMARY.md`
</output>
