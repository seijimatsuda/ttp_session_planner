---
phase: 14-ios-ipad-optimization
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - frontend/src/components/MediaUpload.tsx
autonomous: false

must_haves:
  truths:
    - "Video preview in MediaUpload plays correctly on iOS Safari"
    - "Video scrubbing works on iOS Safari"
    - "Drag-and-drop feels responsive on iPad"
    - "All touch interactions work in field conditions"
  artifacts:
    - path: "frontend/src/components/MediaUpload.tsx"
      provides: "Video preview with proxy URL for iOS compatibility"
      contains: "getProxyMediaUrl"
  key_links:
    - from: "MediaUpload.tsx"
      to: "getProxyMediaUrl"
      via: "import and usage"
      pattern: "getProxyMediaUrl.*drills"
---

<objective>
Ensure MediaUpload video preview uses proxy URL for iOS compatibility and verify complete iOS/iPad experience on real device.

Purpose: Guarantee video playback and touch interactions work correctly on iPads in field conditions.
Output: MediaUpload using proxy URLs, verified iOS experience on real device.
</objective>

<execution_context>
@/Users/seijimatsuda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seijimatsuda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-ios-ipad-optimization/14-RESEARCH.md

# Components to update
@frontend/src/components/MediaUpload.tsx
@frontend/src/lib/media.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MediaUpload to use proxy URL for video preview</name>
  <files>frontend/src/components/MediaUpload.tsx</files>
  <action>
The MediaUpload component currently uses signed URLs directly from Supabase for video preview. This works for images but may fail for videos on iOS Safari due to Range request requirements.

Update the video preview to use proxy URL:

1. Add import at top of file:
```tsx
import { getProxyMediaUrl } from '../lib/media'
```

2. Update the video preview section (around line 209-218):
```tsx
// Current:
{previewUrl && mediaType === 'video' && (
  <video
    src={previewUrl}
    controls
    playsInline
    className="max-h-48 mx-auto rounded"
  >
    Your browser does not support video playback.
  </video>
)}

// Change to:
{uploadedFilePath && mediaType === 'video' && (
  <video
    src={getProxyMediaUrl('drills', uploadedFilePath)}
    controls
    playsInline
    preload="metadata"
    className="max-h-48 mx-auto rounded"
  >
    Your browser does not support video playback.
  </video>
)}
```

Key changes:
- Use `uploadedFilePath` (always available when showing preview) instead of `previewUrl`
- Use `getProxyMediaUrl('drills', uploadedFilePath)` for iOS Range request support
- Add `preload="metadata"` for consistency with DrillDetail pattern
- Image preview continues to use `previewUrl` (signed URL) - images don't need Range requests

Note: Keep the signed URL logic for images - only videos need the proxy.
  </action>
  <verify>
Run TypeScript check: `cd frontend && npx tsc --noEmit`
Test video upload flow - preview should display correctly.
  </verify>
  <done>MediaUpload video preview uses getProxyMediaUrl for iOS Safari compatibility.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete iOS/iPad optimization including:
- Touch targets fixed to 44px on TagInput, MediaUpload, auth pages (Plan 01)
- Video preview using proxy URL for iOS Range request support (Task 1)
- All prior iOS work from Phase 5, 6, 10 (backend proxy, TouchSensor, playsInline)
  </what-built>
  <how-to-verify>
**Test on real iPad or iPhone with iOS Safari:**

1. **Video Playback Test (DrillDetail)**
   - Navigate to an existing drill with video
   - Verify video plays without errors
   - Verify scrubbing (seeking to different timestamps) works
   - Expected: Smooth playback and seek with no console errors

2. **Video Upload Preview Test (AddDrillPage)**
   - Navigate to /drills/new
   - Upload a short video file
   - Verify preview plays inline (not fullscreen)
   - Verify scrubbing works in preview
   - Expected: Video plays inline with working seek

3. **Touch Target Test**
   - Test TagInput: Add tags, tap X to remove - should be easy to tap
   - Test MediaUpload: Cancel during upload, Delete after upload - easy to tap
   - Test Auth links: Tap "Sign up" on login page - easy to tap
   - Expected: All taps register on first attempt with normal finger pressure

4. **Drag-and-Drop Test (SessionPlannerPage)**
   - Navigate to /session/new
   - Hold finger on drill card for 250ms, then drag to grid
   - Expected: Drag initiates after hold, feels responsive
   - Click a drill, then tap a grid cell
   - Expected: Click-to-place works as alternative to drag

5. **General Field Conditions Test**
   - Test in bright light (outdoor visibility)
   - Test with slightly wet/sweaty fingers
   - Expected: UI remains usable in realistic coaching conditions
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
After Task 1:
1. `cd frontend && npx tsc --noEmit` - no TypeScript errors
2. Test video upload flow - preview displays and plays

After checkpoint:
1. All iOS Safari behaviors verified on real device
2. Touch interactions work correctly
3. Drag-and-drop responsive on iPad
</verification>

<success_criteria>
- [ ] MediaUpload video preview uses getProxyMediaUrl
- [ ] Video playback works on iOS Safari (real device)
- [ ] Video scrubbing works on iOS Safari (real device)
- [ ] Touch targets easily tappable on iPad
- [ ] Drag-and-drop responsive on iPad
- [ ] User approves checkpoint verification
</success_criteria>

<output>
After completion, create `.planning/phases/14-ios-ipad-optimization/14-02-SUMMARY.md`
</output>
