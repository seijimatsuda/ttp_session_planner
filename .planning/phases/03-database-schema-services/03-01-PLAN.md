---
phase: 03-database-schema-services
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

user_setup:
  - service: supabase
    why: "Execute SQL to create tables and RLS policies"
    dashboard_config:
      - task: "Run SQL migration in SQL Editor"
        location: "Supabase Dashboard -> SQL Editor"

must_haves:
  truths:
    - "Drills table exists in Supabase database"
    - "Sessions table exists in Supabase database"
    - "RLS policies prevent users from accessing other users' data"
    - "user_id columns have indexes for RLS performance"
  artifacts:
    - path: "supabase/migrations/00001_create_drills_and_sessions.sql"
      provides: "SQL migration file for version control"
      contains: "create table public.drills"
  key_links:
    - from: "drills.user_id"
      to: "auth.users"
      via: "foreign key reference"
      pattern: "references auth.users"
    - from: "sessions.user_id"
      to: "auth.users"
      via: "foreign key reference"
      pattern: "references auth.users"
---

<objective>
Create the drills and sessions database tables with Row Level Security policies in Supabase.

Purpose: Establish the data foundation for drill and session management. RLS ensures multi-tenant isolation so users can only access their own data.

Output: Drills and sessions tables with RLS policies and performance indexes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-database-schema-services/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SQL migration file</name>
  <files>supabase/migrations/00001_create_drills_and_sessions.sql</files>
  <action>
Create directory structure and migration file:

```bash
mkdir -p /Users/seijimatsuda/session_planner_1-22-26/supabase/migrations
```

Create the migration file `supabase/migrations/00001_create_drills_and_sessions.sql` with the following SQL:

```sql
-- Migration: Create drills and sessions tables with RLS
-- Created: 2026-01-22
-- Phase: 03-database-schema-services

-- =============================================================================
-- DRILLS TABLE
-- =============================================================================

create table public.drills (
  id uuid primary key default gen_random_uuid(),
  created_at timestamptz default now() not null,
  name text not null,
  video_url text,
  video_file_path text,
  category text check (category in ('activation', 'dribbling', 'passing', 'shooting')),
  num_players integer,
  equipment text[],
  tags text[],
  user_id uuid references auth.users not null,
  creator_email text
);

-- Enable RLS
alter table public.drills enable row level security;

-- RLS policies with (SELECT auth.uid()) wrapper for performance
create policy "Users can view own drills"
  on public.drills for select
  to authenticated
  using ((select auth.uid()) = user_id);

create policy "Users can insert own drills"
  on public.drills for insert
  to authenticated
  with check ((select auth.uid()) = user_id);

create policy "Users can update own drills"
  on public.drills for update
  to authenticated
  using ((select auth.uid()) = user_id)
  with check ((select auth.uid()) = user_id);

create policy "Users can delete own drills"
  on public.drills for delete
  to authenticated
  using ((select auth.uid()) = user_id);

-- Performance index for RLS queries
create index drills_user_id_idx on public.drills(user_id);
create index drills_created_at_idx on public.drills(created_at desc);
create index drills_category_idx on public.drills(category);

-- =============================================================================
-- SESSIONS TABLE
-- =============================================================================

create table public.sessions (
  id uuid primary key default gen_random_uuid(),
  created_at timestamptz default now() not null,
  name text not null,
  grid_data jsonb not null default '{"cells": {}}'::jsonb,
  user_id uuid references auth.users not null,
  creator_email text
);

-- Enable RLS
alter table public.sessions enable row level security;

-- RLS policies with (SELECT auth.uid()) wrapper for performance
create policy "Users can view own sessions"
  on public.sessions for select
  to authenticated
  using ((select auth.uid()) = user_id);

create policy "Users can insert own sessions"
  on public.sessions for insert
  to authenticated
  with check ((select auth.uid()) = user_id);

create policy "Users can update own sessions"
  on public.sessions for update
  to authenticated
  using ((select auth.uid()) = user_id)
  with check ((select auth.uid()) = user_id);

create policy "Users can delete own sessions"
  on public.sessions for delete
  to authenticated
  using ((select auth.uid()) = user_id);

-- Performance indexes
create index sessions_user_id_idx on public.sessions(user_id);
create index sessions_created_at_idx on public.sessions(created_at desc);

-- =============================================================================
-- GRANT PERMISSIONS
-- =============================================================================

-- Grant access to authenticated users (required for RLS to work)
grant usage on schema public to authenticated;
grant all on public.drills to authenticated;
grant all on public.sessions to authenticated;
```

IMPORTANT NOTES:
- The (SELECT auth.uid()) wrapper provides 94-99% performance improvement over bare auth.uid()
- category uses CHECK constraint to validate enum values at database level
- grid_data uses JSONB for flexible session layout storage
- user_id is NOT NULL and references auth.users for referential integrity
- Indexes on user_id are CRITICAL for RLS performance
  </action>
  <verify>
```bash
ls /Users/seijimatsuda/session_planner_1-22-26/supabase/migrations/00001_create_drills_and_sessions.sql && echo "Migration file exists"
grep -q "create table public.drills" /Users/seijimatsuda/session_planner_1-22-26/supabase/migrations/00001_create_drills_and_sessions.sql && echo "Drills table SQL present"
grep -q "create table public.sessions" /Users/seijimatsuda/session_planner_1-22-26/supabase/migrations/00001_create_drills_and_sessions.sql && echo "Sessions table SQL present"
grep -q "(select auth.uid())" /Users/seijimatsuda/session_planner_1-22-26/supabase/migrations/00001_create_drills_and_sessions.sql && echo "Optimized RLS wrapper present"
```
  </verify>
  <done>SQL migration file created with drills, sessions, RLS policies, and indexes</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Execute SQL in Supabase Dashboard</name>
  <action>
User must execute the SQL migration in Supabase SQL Editor. Claude cannot directly execute SQL against Supabase.
  </action>
  <instructions>
1. Open your Supabase project dashboard
2. Navigate to SQL Editor (left sidebar)
3. Click "New query" button
4. Copy the ENTIRE contents of `supabase/migrations/00001_create_drills_and_sessions.sql`
5. Paste into the SQL Editor
6. Click "Run" (or press Cmd/Ctrl + Enter)
7. Verify both statements succeed (green checkmarks)
8. Verify tables appear in Table Editor:
   - Click "Table Editor" in left sidebar
   - You should see: drills, sessions
9. Verify RLS is enabled:
   - Click on "drills" table
   - Click "Policies" tab
   - Should see 4 policies (select, insert, update, delete)
   - Repeat for "sessions" table
  </instructions>
  <resume-signal>
Type "done" after executing the SQL and verifying:
- Both tables appear in Table Editor
- RLS policies are visible (4 per table)

Or paste any error messages if the SQL failed.
  </resume-signal>
</task>

<task type="auto">
  <name>Task 3: Verify schema via Supabase API</name>
  <files></files>
  <action>
Test that the tables were created correctly by querying them via the Supabase client.

Create a temporary test script to verify the schema. Run from the backend directory:

```bash
cd /Users/seijimatsuda/session_planner_1-22-26/backend

# Create temp test file
cat > /tmp/test-schema.ts << 'EOF'
import 'dotenv/config'
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = process.env.SUPABASE_URL!
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!

const supabase = createClient(supabaseUrl, supabaseServiceKey)

async function testSchema() {
  console.log('Testing drills table...')
  const { data: drillsInfo, error: drillsError } = await supabase
    .from('drills')
    .select('*')
    .limit(0)

  if (drillsError) {
    console.error('Drills table error:', drillsError.message)
  } else {
    console.log('✓ Drills table exists and is accessible')
  }

  console.log('\nTesting sessions table...')
  const { data: sessionsInfo, error: sessionsError } = await supabase
    .from('sessions')
    .select('*')
    .limit(0)

  if (sessionsError) {
    console.error('Sessions table error:', sessionsError.message)
  } else {
    console.log('✓ Sessions table exists and is accessible')
  }

  // Test insert/select with service role (bypasses RLS)
  console.log('\nTesting insert capability (admin)...')
  const testId = crypto.randomUUID()
  const { error: insertError } = await supabase
    .from('drills')
    .insert({
      id: testId,
      name: 'Test Drill',
      category: 'activation',
      user_id: '00000000-0000-0000-0000-000000000000' // Fake user ID for test
    })

  if (insertError) {
    console.error('Insert test error:', insertError.message)
  } else {
    console.log('✓ Insert works (admin bypass)')

    // Clean up test data
    await supabase.from('drills').delete().eq('id', testId)
    console.log('✓ Test data cleaned up')
  }

  console.log('\n=== Schema verification complete ===')
}

testSchema().catch(console.error)
EOF

# Run the test
npx tsx /tmp/test-schema.ts

# Clean up
rm /tmp/test-schema.ts
```

This script verifies:
1. Drills table exists and is queryable
2. Sessions table exists and is queryable
3. Insert/delete operations work (using service_role to bypass RLS)
  </action>
  <verify>
The test script output should show:
- "Drills table exists and is accessible"
- "Sessions table exists and is accessible"
- "Insert works (admin bypass)"
- "Test data cleaned up"
  </verify>
  <done>Schema verified via Supabase API - both tables exist and are functional</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Migration file exists in version control:
```bash
cat /Users/seijimatsuda/session_planner_1-22-26/supabase/migrations/00001_create_drills_and_sessions.sql
```

2. Tables exist in Supabase (verified via API in Task 3)

3. RLS policies are active (verified manually in Task 2)
</verification>

<success_criteria>
- [ ] Migration SQL file exists at `supabase/migrations/00001_create_drills_and_sessions.sql`
- [ ] Drills table created with all columns (id, created_at, name, video_url, video_file_path, category, num_players, equipment, tags, user_id, creator_email)
- [ ] Sessions table created with all columns (id, created_at, name, grid_data, user_id, creator_email)
- [ ] RLS enabled on both tables with 4 policies each
- [ ] Indexes created on user_id, created_at, and category columns
- [ ] API verification script runs successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03-database-schema-services/03-01-SUMMARY.md`
</output>
