---
phase: 11-save-load-sessions
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - frontend/src/components/sessions/SaveSessionDialog.tsx
  - frontend/src/components/sessions/SessionForm.schema.ts
  - frontend/src/components/sessions/index.ts
autonomous: true

must_haves:
  truths:
    - "User can save current session grid with a name"
    - "User can edit existing session name"
    - "Save dialog validates session name is required"
    - "Save shows loading state during mutation"
  artifacts:
    - path: "frontend/src/components/sessions/SaveSessionDialog.tsx"
      provides: "Modal dialog for saving/updating session"
      exports: ["SaveSessionDialog"]
    - path: "frontend/src/components/sessions/SessionForm.schema.ts"
      provides: "Zod schema for session form validation"
      exports: ["sessionFormSchema", "SessionFormData", "sessionFormDefaults"]
    - path: "frontend/src/components/sessions/index.ts"
      provides: "Barrel exports for session components"
  key_links:
    - from: "frontend/src/components/sessions/SaveSessionDialog.tsx"
      to: "useCreateSession, useUpdateSession"
      via: "import from @/hooks/useSessions"
      pattern: "use(Create|Update)Session"
    - from: "frontend/src/components/sessions/SaveSessionDialog.tsx"
      to: "react-hook-form"
      via: "useForm with zodResolver"
      pattern: "useForm.*zodResolver"
---

<objective>
Create the save session dialog that allows users to name and save their session grid configuration.

Purpose: Provides SESS-06 (save with name) and SESS-09 (edit existing) requirements. This dialog is used by the session planner (Phase 10) when user clicks save.

Output: SaveSessionDialog component ready for integration with session planner grid
</objective>

<execution_context>
@/Users/seijimatsuda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seijimatsuda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-save-load-sessions/11-RESEARCH.md
@frontend/src/hooks/useSessions.ts
@frontend/src/lib/database.types.ts
@frontend/src/components/drills/DrillForm.schema.ts
@frontend/src/components/drills/DrillForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session form Zod schema</name>
  <files>frontend/src/components/sessions/SessionForm.schema.ts</files>
  <action>
Create `frontend/src/components/sessions/SessionForm.schema.ts`:

Follow DrillForm.schema.ts pattern:

```typescript
import { z } from 'zod'
import type { GridData } from '@/lib/database.types'

/**
 * Zod schema for session form validation
 */
export const sessionFormSchema = z.object({
  name: z
    .string()
    .min(1, 'Session name is required')
    .max(100, 'Session name must be 100 characters or less'),
})

export type SessionFormData = z.infer<typeof sessionFormSchema>

/**
 * Default values for session form
 */
export const sessionFormDefaults: SessionFormData = {
  name: '',
}
```

Note: grid_data is NOT in the form schema - it's passed separately as a prop since it comes from the grid state, not user input.
  </action>
  <verify>`cd frontend && npx tsc --noEmit` passes</verify>
  <done>Schema exports sessionFormSchema, SessionFormData, sessionFormDefaults</done>
</task>

<task type="auto">
  <name>Task 2: Create SaveSessionDialog component</name>
  <files>frontend/src/components/sessions/SaveSessionDialog.tsx</files>
  <action>
Create `frontend/src/components/sessions/SaveSessionDialog.tsx`:

Props interface:
```typescript
interface SaveSessionDialogProps {
  isOpen: boolean
  onClose: () => void
  gridData: GridData
  existingSession?: Session | null  // If editing, pass the session
  onSuccess?: (sessionId: string) => void
}
```

Implementation:
1. Import Dialog, DialogPanel, DialogTitle, DialogBackdrop from @headlessui/react
2. Import useForm from react-hook-form with zodResolver
3. Import useAuth, useCreateSession, useUpdateSession
4. Import Input, Button from @/components/ui
5. Import toast from sonner
6. Import schema from ./SessionForm.schema

Form setup:
```typescript
const { register, handleSubmit, formState: { errors }, reset } = useForm<SessionFormData>({
  resolver: zodResolver(sessionFormSchema),
  defaultValues: existingSession
    ? { name: existingSession.name }
    : sessionFormDefaults,
  mode: 'onBlur',
})
```

Important: Use useEffect to reset form when existingSession changes:
```typescript
useEffect(() => {
  if (isOpen) {
    reset(existingSession ? { name: existingSession.name } : sessionFormDefaults)
  }
}, [isOpen, existingSession, reset])
```

Submit handler:
```typescript
const onSubmit = async (data: SessionFormData) => {
  try {
    if (existingSession) {
      const updated = await updateMutation.mutateAsync({
        id: existingSession.id,
        updates: { name: data.name, grid_data: gridData as Json }
      })
      toast.success('Session updated!')
      onSuccess?.(updated.id)
    } else {
      const created = await createMutation.mutateAsync({
        name: data.name,
        grid_data: gridData as Json,
        user_id: user!.id,
        creator_email: user!.email,
      })
      toast.success('Session saved!')
      onSuccess?.(created.id)
    }
    onClose()
  } catch (error) {
    toast.error('Failed to save session')
  }
}
```

Dialog structure:
- Dialog with open={isOpen} onClose={onClose} className="relative z-50"
- DialogBackdrop with fixed inset-0 bg-black/30
- Centered container
- DialogPanel with max-w-md, rounded-lg, bg-white, p-6
- DialogTitle: "Save Session" or "Update Session" based on existingSession
- Form with onSubmit={handleSubmit(onSubmit)}
- Input for name with label, error display, autoFocus
- Button row: Cancel (secondary, onClick onClose) and Save/Update (primary, loading state)

Loading state: isPending from whichever mutation is active
Disable form when: isSubmitting || createMutation.isPending || updateMutation.isPending
  </action>
  <verify>`cd frontend && npx tsc --noEmit` passes</verify>
  <done>SaveSessionDialog handles both create and edit modes with validation</done>
</task>

<task type="auto">
  <name>Task 3: Create barrel exports for session components</name>
  <files>frontend/src/components/sessions/index.ts</files>
  <action>
Create `frontend/src/components/sessions/index.ts`:

```typescript
export { SessionList } from './SessionList'
export { SessionListItem } from './SessionListItem'
export { SaveSessionDialog } from './SaveSessionDialog'
export { sessionFormSchema, sessionFormDefaults } from './SessionForm.schema'
export type { SessionFormData } from './SessionForm.schema'
```

This allows clean imports:
```typescript
import { SessionList, SaveSessionDialog } from '@/components/sessions'
```
  </action>
  <verify>`cd frontend && npx tsc --noEmit` passes</verify>
  <done>All session components and types exportable from single index</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` passes
2. `cd frontend && npm run build` succeeds
3. Components can be imported: `import { SaveSessionDialog, SessionList } from '@/components/sessions'`
</verification>

<success_criteria>
- SessionForm.schema.ts provides Zod validation for name field
- SaveSessionDialog works for both create (new session) and edit (existing session)
- Form shows validation errors for empty/long names
- Loading state shown during save mutation
- Success toast appears after save
- Barrel exports work for all session components
</success_criteria>

<output>
After completion, create `.planning/phases/11-save-load-sessions/11-03-SUMMARY.md`
</output>
