---
phase: 11-save-load-sessions
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/App.tsx
  - frontend/src/pages/SessionPlannerPage.tsx
  - frontend/src/hooks/useSessionGrid.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can save current session grid with a name"
    - "User can load saved session to populate grid"
    - "User can edit existing session (update drills and save)"
  artifacts:
    - path: "frontend/src/App.tsx"
      provides: "/sessions/:id/edit route"
      contains: "path='/sessions/:id/edit'"
    - path: "frontend/src/pages/SessionPlannerPage.tsx"
      provides: "Complete save/load/edit integration"
      min_lines: 130
    - path: "frontend/src/hooks/useSessionGrid.ts"
      provides: "setGridData function for loading session data"
      contains: "setGridData"
  key_links:
    - from: "SessionPlannerPage.tsx"
      to: "SaveSessionDialog"
      via: "import and render with isOpen state"
      pattern: "SaveSessionDialog.*isOpen"
    - from: "SessionPlannerPage.tsx"
      to: "useSession"
      via: "import and conditional fetch"
      pattern: "useSession\\(.*id"
    - from: "SessionPlannerPage.tsx"
      to: "useParams"
      via: "import and id extraction"
      pattern: "useParams.*id"
    - from: "App.tsx"
      to: "SessionPlannerPage"
      via: "/sessions/:id/edit route"
      pattern: "path.*sessions/:id/edit"
---

<objective>
Close Phase 11 verification gaps by wiring save/load/edit functionality into SessionPlannerPage

Purpose: Complete the "last mile" integration work to make save, load, and edit session flows fully functional. All building blocks exist (SaveSessionDialog, useSession hook, useSessionGrid) but are not connected.

Output: Fully functional session planner where users can save new sessions, load existing sessions to edit, and update sessions - closing all 3 verification gaps.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-save-load-sessions/11-VERIFICATION.md
@.planning/phases/11-save-load-sessions/11-03-SUMMARY.md
@frontend/src/pages/SessionPlannerPage.tsx
@frontend/src/App.tsx
@frontend/src/hooks/useSessionGrid.ts
@frontend/src/hooks/useSessions.ts
@frontend/src/components/sessions/SaveSessionDialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add /sessions/:id/edit route to App.tsx</name>
  <files>frontend/src/App.tsx</files>
  <action>
Add the missing edit session route to App.tsx. Insert it BEFORE the /sessions/new route for correct specificity (more specific paths first).

1. Add route inside the protected routes section:
   ```tsx
   <Route path="/sessions/:id/edit" element={<SessionPlannerPage />} />
   ```

2. Place it in this order (after drill routes, before sessions/new):
   ```tsx
   {/* Session routes - most specific first */}
   <Route path="/sessions/:id/edit" element={<SessionPlannerPage />} />
   <Route path="/sessions/new" element={<SessionPlannerPage />} />
   <Route path="/sessions" element={<SessionsPage />} />
   ```

No new imports needed - SessionPlannerPage is already imported.
  </action>
  <verify>
1. Run `grep -n "sessions/:id/edit" frontend/src/App.tsx` - should find the new route
2. Run `cd /Users/seijimatsuda/session_planner_1-22-26/frontend && npm run build 2>&1 | head -30` - should complete without errors
  </verify>
  <done>Route /sessions/:id/edit exists in App.tsx pointing to SessionPlannerPage</done>
</task>

<task type="auto">
  <name>Task 2: Wire save/load/edit functionality into SessionPlannerPage</name>
  <files>
    frontend/src/pages/SessionPlannerPage.tsx
    frontend/src/hooks/useSessionGrid.ts
  </files>
  <action>
Complete integration of save, load, and edit flows. This is the main gap closure task.

**Step 1: Update useSessionGrid hook to expose setGridData**

In `frontend/src/hooks/useSessionGrid.ts`:
- Add `setGridData` to the return object so SessionPlannerPage can set grid data when loading a session
- Keep the existing useState setter, just expose it

```typescript
return {
  gridData,
  setGridData,  // ADD THIS LINE
  selectedDrillId,
  placeDrill,
  removeDrill,
  selectDrill,
  handleCellClick,
}
```

**Step 2: Update SessionPlannerPage with full save/load/edit integration**

In `frontend/src/pages/SessionPlannerPage.tsx`:

1. Add imports at top:
```typescript
import { useState, useMemo, useEffect } from 'react'
import { useParams, useNavigate } from 'react-router-dom'
import { useSession } from '@/hooks/useSessions'
import { SaveSessionDialog } from '@/components/sessions'
import { Button } from '@/components/ui/Button'
import type { Session } from '@/lib/database.types'
```

2. Get URL params and navigation:
```typescript
const { id: sessionId } = useParams<{ id: string }>()
const navigate = useNavigate()
```

3. Fetch session data when editing (after auth, before grid hook):
```typescript
const { data: existingSession, isLoading: isLoadingSession } = useSession(sessionId)
```

4. Update useSessionGrid call to use initial data from loaded session:
```typescript
const {
  gridData,
  setGridData,
  selectedDrillId,
  placeDrill,
  removeDrill,
  selectDrill,
  handleCellClick,
} = useSessionGrid({
  initialGridData: existingSession?.grid_data as GridData | undefined,
})
```

5. Use effect to update grid when session loads (for when grid was created before data arrived):
```typescript
useEffect(() => {
  if (existingSession?.grid_data) {
    setGridData(existingSession.grid_data as GridData)
  }
}, [existingSession, setGridData])
```

6. Add save dialog state:
```typescript
const [isSaveDialogOpen, setIsSaveDialogOpen] = useState(false)
```

7. Add success handler:
```typescript
const handleSaveSuccess = (savedSessionId: string) => {
  // If this was a new session, navigate to the edit URL so subsequent saves update instead of create
  if (!sessionId) {
    navigate(`/sessions/${savedSessionId}/edit`, { replace: true })
  }
}
```

8. Determine edit mode and page title:
```typescript
const isEditMode = !!sessionId
const pageTitle = isEditMode
  ? existingSession?.name ? `Edit: ${existingSession.name}` : 'Edit Session'
  : 'New Session'
```

9. Add loading state for session fetch:
```typescript
if (isLoadingSession && sessionId) {
  return (
    <AppShell>
      <Container as="main" className="py-6">
        <div className="text-gray-500">Loading session...</div>
      </Container>
    </AppShell>
  )
}
```

10. Update page header with title and Save button:
```tsx
<div className="flex items-center justify-between mb-6">
  <h1 className="text-2xl font-bold">{pageTitle}</h1>
  <Button onClick={() => setIsSaveDialogOpen(true)}>
    {isEditMode ? 'Update Session' : 'Save Session'}
  </Button>
</div>
```

11. Add SaveSessionDialog at the end of the component (before closing AppShell):
```tsx
<SaveSessionDialog
  isOpen={isSaveDialogOpen}
  onClose={() => setIsSaveDialogOpen(false)}
  gridData={gridData}
  existingSession={existingSession}
  onSuccess={handleSaveSuccess}
/>
```

12. Add GridData type import:
```typescript
import type { GridData, Session } from '@/lib/database.types'
```

NOTE: The existingSession from useSession returns Session | null | undefined, and SaveSessionDialog accepts Session | null | undefined, so types should align.
  </action>
  <verify>
1. Run TypeScript compilation:
   ```bash
   cd /Users/seijimatsuda/session_planner_1-22-26/frontend && npm run build 2>&1 | head -50
   ```
   Should complete without errors in our files.

2. Verify Save button and dialog integration:
   ```bash
   grep -n "SaveSessionDialog" frontend/src/pages/SessionPlannerPage.tsx
   grep -n "isSaveDialogOpen" frontend/src/pages/SessionPlannerPage.tsx
   ```
   Should find imports and usage.

3. Verify session loading:
   ```bash
   grep -n "useSession" frontend/src/pages/SessionPlannerPage.tsx
   grep -n "useParams" frontend/src/pages/SessionPlannerPage.tsx
   ```
   Should find both hooks used.

4. Verify setGridData exposure:
   ```bash
   grep -n "setGridData" frontend/src/hooks/useSessionGrid.ts
   ```
   Should find it in return statement.
  </verify>
  <done>
SessionPlannerPage has:
- Save button in header that opens SaveSessionDialog
- URL param detection for edit mode (/sessions/:id/edit)
- Session data loading via useSession hook when editing
- Grid populated with loaded session's grid_data
- Edit mode detected and passed to SaveSessionDialog
- Page title shows "New Session" or "Edit: [name]"
- After saving new session, URL updates to edit mode for subsequent saves
  </done>
</task>

</tasks>

<verification>
## Functional Tests (manual verification)

1. **Save new session flow:**
   - Navigate to /sessions/new
   - Drag some drills into grid
   - Click "Save Session" button
   - Enter name in dialog, click Save
   - Toast shows "Session saved!"
   - URL changes to /sessions/[id]/edit

2. **Load session flow:**
   - Navigate to /sessions
   - Click "Load" on a session
   - Page loads at /sessions/[id]/edit
   - Grid populates with saved drill placements
   - Title shows "Edit: [session name]"

3. **Edit session flow:**
   - From loaded session, modify grid (add/remove drills)
   - Click "Update Session" button
   - Dialog shows "Update Session" title
   - Enter/modify name, click Update
   - Toast shows "Session updated!"
   - Changes persist on refresh

## Automated Checks

```bash
# Route exists
grep "sessions/:id/edit" frontend/src/App.tsx

# Save dialog integrated
grep -c "SaveSessionDialog" frontend/src/pages/SessionPlannerPage.tsx  # should be >= 2 (import + usage)

# Session loading integrated
grep -c "useSession" frontend/src/pages/SessionPlannerPage.tsx  # should be >= 1

# URL params used
grep -c "useParams" frontend/src/pages/SessionPlannerPage.tsx  # should be >= 1

# Build passes
cd frontend && npm run build
```
</verification>

<success_criteria>
1. /sessions/:id/edit route exists and renders SessionPlannerPage
2. Save button visible on SessionPlannerPage that opens SaveSessionDialog
3. New sessions can be saved and URL updates to edit mode
4. Existing sessions load when navigating to /sessions/:id/edit
5. Loaded session's grid_data populates the grid
6. Updates to existing sessions persist correctly
7. TypeScript compilation passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-save-load-sessions/11-04-SUMMARY.md`
</output>
